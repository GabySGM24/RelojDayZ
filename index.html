<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hora DayZ</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0c3e8f">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
  <style>
    :root{ --bg1:#0a2a75; --bg2:#0f3fa6; --glow:#8fc6ff; --text:#e8f3ff; --muted:#b9d3ff; --btn:#1e63ff; --btn-press:#0f4be0; }
    body{ margin:0; height:100vh; display:grid; place-items:center; background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; padding:24px; }
    .card{ width:min(92vw,560px); background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); border-radius:28px; padding:26px; text-align:center; backdrop-filter:blur(6px); box-shadow:18px 18px 40px rgba(0,0,0,.55), -10px -10px 24px rgba(255,255,255,.08); }
    .display{ font-family:'Orbitron', ui-monospace, monospace; font-weight:900; font-size:clamp(56px,11vw,120px); color:var(--glow); text-shadow:0 0 12px rgba(143,198,255,.75),0 0 26px rgba(143,198,255,.45),0 6px 30px rgba(0,0,0,.7); padding:22px 16px; border-radius:22px; border:1px solid rgba(255,255,255,.16); margin:6px auto 14px; }
    .badge{ display:inline-block; padding:10px 16px; border-radius:999px; border:1px solid rgba(255,255,255,.12); font-weight:700; margin-bottom:16px; }
    .badge.day{ background:linear-gradient(180deg, rgba(56,189,248,.25), rgba(59,130,246,.18)); }
    .badge.night{ background:linear-gradient(180deg, rgba(148,163,184,.25), rgba(71,85,105,.22)); }
    .row{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin:8px 0 14px; }
    .row label{ font-size:14px; color:var(--muted); }
    .row input{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18); color:#fff; border-radius:10px; padding:8px 10px; }
    .btn{ border:0; background:linear-gradient(180deg,var(--btn),#1652ff); color:#fff; font-weight:700; padding:10px 18px; border-radius:999px; cursor:pointer; }
    .btn:active{ background:linear-gradient(180deg,var(--btn-press),#0f46c9); }
    .hint{ font-size:12px; color:rgba(233,243,255,.7); margin-top:10px; }
  </style>
</head>
<body>
  <main class="card">
    <div id="display" class="display">--:--</div>
    <div id="badge" class="badge night">Cargandoâ€¦</div>

    <!-- Controles para ajustar amanecer/anochecer -->
    <div class="row">
      <label>ðŸŒ… Amanecer: <input id="inSunrise" type="time" value="05:00"></label>
      <label>ðŸŒ‡ Anochecer: <input id="inSunset" type="time" value="21:00"></label>
      <button class="btn" id="btnSave">Guardar</button>
    </div>

    <button class="btn" id="btnRefresh">Actualizar</button>
    <div class="hint">DÃ­a â‰ˆ 3 h Â· Noche â‰ˆ 40 min (oficial). El horario exacto depende del servidor. </div>
  </main>

  <script>
    const serverId = "30957355"; // BattleMetrics
    // Carga config guardada o valores por defecto
    function loadConfig(){
      const sunrise = localStorage.getItem('sunrise') || '05:00';
      const sunset  = localStorage.getItem('sunset')  || '21:00';
      inSunrise.value = sunrise;
      inSunset.value  = sunset;
      return { sunrise, sunset };
    }
    function toMinutes(HHMM){ const [h,m]=HHMM.split(':').map(Number); return h*60+m; }

    async function fetchServer(id){
      const url = `https://api.battlemetrics.com/servers/${encodeURIComponent(id)}`;
      const r = await fetch(url,{ headers:{ 'Accept':'application/vnd.api+json' }});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }
    function* walk(obj, path=[]){
      if(obj && typeof obj==='object'){
        for(const k of Object.keys(obj)){
          const v=obj[k], newPath=path.concat(k);
          yield {key:k, value:v, path:newPath};
          if(v && typeof v==='object') yield* walk(v,newPath);
        }
      }
    }
    const display = document.getElementById('display');
    const badge   = document.getElementById('badge');
    const inSunrise = document.getElementById('inSunrise');
    const inSunset  = document.getElementById('inSunset');
    const btnSave   = document.getElementById('btnSave');
    const btnRefresh= document.getElementById('btnRefresh');

    btnSave.onclick = () => {
      localStorage.setItem('sunrise', inSunrise.value);
      localStorage.setItem('sunset',  inSunset.value);
      load(); // recalcular con los nuevos
    };
    btnRefresh.onclick = () => load();

    async function load(){
      try{
        const {sunrise, sunset} = loadConfig();
        const json = await fetchServer(serverId);
        const attrs = json?.data?.attributes ?? {};
        let hora = null;
        for(const entry of walk(attrs)){
          const path = entry.path.join('.');
          if(/time/i.test(entry.key) || /time/i.test(path)){
            if(typeof entry.value==='string' && /^\d{2}:\d{2}$/.test(entry.value)){
              hora = entry.value; break;
            }
          }
        }
        if(!hora) throw new Error('No se detectÃ³ hora');

        display.textContent = hora;

        const totalMin = toMinutes(hora);
        const isDay = totalMin >= toMinutes(sunrise) && totalMin < toMinutes(sunset);
        badge.textContent = isDay ? 'Es de DÃA' : 'Es de NOCHE';
        badge.className = 'badge ' + (isDay ? 'day' : 'night');

        localStorage.setItem('lastHora', hora);
        localStorage.setItem('lastIsDay', String(isDay));
      }catch(err){
        const last = localStorage.getItem('lastHora');
        const lastIsDay = localStorage.getItem('lastIsDay')==='true';
        if(last){
          display.textContent = last + ' *';
          badge.textContent = lastIsDay ? 'DÃA (cache)' : 'NOCHE (cache)';
          badge.className = 'badge ' + (lastIsDay ? 'day' : 'night');
        }else{
          display.textContent = 'Error';
          badge.textContent = err.message;
          badge.className = 'badge night';
        }
        console.log(err);
      }
    }

    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('service-worker.js').catch(()=>{});
    }
    load();
    setInterval(load, 60000);
  </script>
</body>
</html>
